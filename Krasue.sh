#!/bin/bash
#$t@$h
# This script modifies your system when
# it writes the results to report.txt
# But otherwise tidies up when finished
# Run as root. It's the only way
DEPENDENCIES=(chkrootkit nmap john)
installed_packages=()

install_dependencies() {
    for pkg in "${DEPENDENCIES[@]}"; do
        if ! dpkg -s "$pkg" &> /dev/null; then
            sudo apt-get install -y "$pkg"
            installed_packages+=("$pkg")
        fi
    done
}

system_calls() {
    grep -v '^#' /proc/kallsyms | grep sys_call_table
}

network_traffic() {
    sudo tcpdump -i any 'port 554' -w rtsp_traffic.pcap -v
}

detect_rootkits() {
    chkrootkit
}

patch_system() {
    sudo apt-get update
    sudo apt-get upgrade -y
}

password_strength() {
    sudo john --test  # TODO: implement this
}

endpoint_security() {
    sudo nmap -sS -O localhost
}

generate_report() {
    system_calls > security_report.txt
    network_traffic >> security_report.txt
    detect_rootkits >> security_report.txt
    password_strength >> security_report.txt
    endpoint_security >> security_report.txt
}

cleanup_dependencies() {
    for pkg in "${installed_packages[@]}"; do
        sudo apt-get remove --purge -y "$pkg"
    done
}

install_dependencies
patch_system
generate_report
cleanup_dependencies

echo "Krasue checks complete. security_report.txt written."
