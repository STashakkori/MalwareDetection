#!/bin/bash
#$t@$h
# Make sure tcpdump is installed
# Run privileged
# This script does NOT modify your system
# Configure your net
# Configure your SMTP. Example:
#   sudo apt-get install msmtp msmtp-mta
#   Then edit: ~/.msmtprc
interface="eth0" # Interface
syn_threshold=100 # Packet limit
recipient="recipient_email@etc.com" # Recipient email
sender="your_email@otheretc.com" # Your email

send_email() {
    subject=$1
    body=$2
    echo -e "Subject: $subject\n\n$body" | msmtp --account=gmail --from="$sender" "$recipient"
}

tcpdump -i "$interface" 'tcp[tcpflags] & (tcp-syn|tcp-push) != 0' -l |
while read -r line; do
    src_ip=$(echo "$line" | grep -oP 'IP \K[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+')

    # Detect SYN-PSH
    if [[ $line == *" PSH "* ]]; then
        send_email "PSH Flag Alert" "PSH flag detected from: $src_ip."
    fi

    # Detect limit
    declare -A syn_count
    if [[ $line == *" SYN "* && $line != *" ACK "* ]]; then
        ((syn_count[$src_ip]++))
        if [[ ${syn_count[$src_ip]} -gt $syn_threshold ]]; then
            send_email "SYN Flood Alert" "Potential SYN flood detected from: $src_ip."
            syn_count[$src_ip]=0
        fi
    fi
done
